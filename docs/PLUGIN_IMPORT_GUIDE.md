# 插件导入指南

本文档介绍如何使用 GUI_Manager 的“导入插件”功能，将外部代码一键导入为可管理的插件。

## 功能概述

插件导入功能允许：
- 从外部文件夹导入现有代码
- 配置插件基本信息（ID、名称）
- 选择插件类型（UI 插件 / 无界面插件）
- 指定入口文件与入口函数（或类.方法）
- 为无界面插件定义参数（在通用参数面板展现）
 - 自动生成包装 `__init__.py` 与基本 `config.json`

## 如何导入插件

### 导入步骤

1. 在“插件管理”页签点击“导入插件”
2. 在弹出的对话框中：
   - 选择插件源文件夹（包含入口及依赖文件）
   - 填写插件 ID、插件名称
   - 选择插件类型（UI 插件/无界面插件）
   - 指定入口文件与入口函数（支持 `ClassName.method`）
   - 如需，为无界面插件添加参数（名称、类型、默认值等）
3. 点击"导入"按钮完成导入
4. 系统会递归复制源目录到插件目录（忽略隐藏项、`__pycache__`），并生成 `__init__.py` 包装类与 `config.json`
5. 导入成功后，插件列表将自动刷新，新导入的插件将显示在列表中

## 插件类型配置

### UI 插件

UI 插件为带界面插件：
- 入口可指向一个 UI 类，系统会尝试创建并嵌入到 Tab 中；如失败，会回退到占位界面。

### 无界面插件

后台运行、无 UI：
- 入口可为函数或 `ClassName.method`；若需参数，可在导入时配置，系统会在通用参数面板展现。
 - 运行时参数以 `parameters_values`（或 `get_parameters()`）提供给插件逻辑

## 参数配置说明

对于无界面插件，您可以定义多种类型的参数，系统会自动为这些参数生成配置界面，并在插件运行时提供参数值。

### 支持的参数类型

1. **字符串 (String)**
   - 用于文本输入
   - 配置项：
     - 参数名：在代码中引用的名称
     - 标签：显示在界面上的名称
     - 描述：参数的详细说明
     - 默认值：参数的默认值

2. **整数 (Integer)**
   - 用于整数输入
   - 配置项：
     - 参数名
     - 标签
     - 描述
     - 默认值
     - 最小值（可选）
     - 最大值（可选）

3. **浮点数 (Float)**
   - 用于小数输入
   - 配置项：
     - 参数名
     - 标签
     - 描述
     - 默认值
     - 最小值（可选）
     - 最大值（可选）

4. **布尔值 (Boolean)**
   - 用于开关设置
   - 配置项：
     - 参数名
     - 标签
     - 描述
     - 默认值（True/False）

5. **下拉选择 (Select)**
   - 用于从预定义选项中选择
   - 配置项：
     - 参数名
     - 标签
     - 描述
     - 默认值
     - 选项列表：包含选项值和显示标签

### 在插件中使用参数（导入生成的包装类会将参数注入为 `parameters_values`）

导入的无界面插件可以通过以下方式获取参数值：

```python
def run(self):
    # 获取所有参数值
    params = self.get_parameters()
    
    # 使用特定参数
    param_value = params.get('parameter_name', default_value)
```
 
建议：
- 复杂参数可序列化为 JSON 字符串或路径，在插件内自行解析
- 为每个参数提供清晰的标签与描述，便于用户理解

## 插件文件结构要求

导入的插件应包含以下内容：
- 主程序文件（包含指定的入口类或函数）
- 相关的依赖文件（如有）
 - 如有资源（图片/UI 文件），请与入口同目录或子目录，便于一并复制

## 运行机制与注意事项

1. 插件 ID 必须唯一。
2. 程序入口必须存在于所选源目录中。
3. 运行入口模块前系统会把插件目录临时插入 `sys.path`，以支持同级导入（如 `from moudleA import ...`）。
4. 导入后，插件会复制到系统插件目录（原目录不会被修改）；如需更改请直接编辑系统插件目录中的文件。
5. 如需第三方依赖，请在主项目 `requirements.txt` 中统一或在 README 中清晰说明

## 示例

### 导入 UI 插件示例

1. 准备一个包含以下内容的Python文件：

```python
# my_ui_plugin.py
from PySide6.QtWidgets import QWidget, QVBoxLayout, QLabel, QPushButton

class MyCustomUI(QWidget):
    def __init__(self):
        super().__init__()
        layout = QVBoxLayout(self)
        layout.addWidget(QLabel("这是我的自定义UI插件"))
        layout.addWidget(QPushButton("点击按钮"))
```

2. 导入时配置：
   - 插件类型：UI插件
   - 程序入口：my_ui_plugin.py中的MyCustomUI类

### 导入带参数的无界面插件示例

1. 准备一个包含以下内容的Python文件：

```python
# my_param_plugin.py
def process_data(params):
    # 获取参数
    count = params.get('count', 10)
    name = params.get('name', 'default')
    
    # 执行处理逻辑
    print(f"Processing {count} items for {name}")
```

2. 导入时配置：
   - 插件类型：无界面插件
   - 程序入口：my_param_plugin.py中的process_data函数
   - 添加参数：
     - count (整数，默认值10，范围1-100)
     - name (字符串，默认值'default')

## 故障排除

- **导入失败**：检查插件ID是否已存在，或程序入口是否正确
- **参数不生效**：确保参数名称在代码中正确引用
- **插件运行错误**：查看插件输出日志获取详细错误信息
 - **UI 未显示**：确认入口为可实例化的 QWidget 或正确的 UI 类
 - **同级导入失败**：优先通过导入器创建的插件结构；若手动拷贝，请检查包结构与 `sys.path` 设置

如有其他问题，请参考系统日志获取更多诊断信息。